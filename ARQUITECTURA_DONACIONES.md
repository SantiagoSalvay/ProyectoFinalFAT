# ๐ DIAGRAMA DE ARQUITECTURA - Sistema de Donaciones

## ๐๏ธ Estructura General

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                        FRONTEND (React + Vite)                      โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ Donaciones.tsx                                               โ  โ
โ  โ โโ Form: ongId, donationType, description, cantidad         โ  โ
โ  โ โโ Submit: POST /api/donations (no-monetaria)              โ  โ
โ  โ        o: POST /api/payments/mp/create (monetaria)         โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                          โ Autenticaciรณn JWT                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                              โ HTTP Requests

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      BACKEND (Node.js + Express)                    โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  donations.js (NEW)      โ    โ  payments.js (MODIFIED)      โ  โ
โ  โ                          โ    โ                              โ  โ
โ  โ โ POST /donations       โ    โ โ POST /mp/create           โ  โ
โ  โ   - Validar ONG          โ    โ   - Crear PedidoDonacion โจ  โ  โ
โ  โ   - Crear PedidoDonacion โ    โ   - Generar preferencia MP   โ  โ
โ  โ   - Estado: "pendiente"  โ    โ   - Guardar pedidoId en meta โ  โ
โ  โ                          โ    โ                              โ  โ
โ  โ โ GET /my-donations     โ    โ โ GET /mp/process-payment   โ  โ
โ  โ   - Listar donaciones    โ    โ   - Callback con metadata    โ  โ
โ  โ                          โ    โ   - Buscar pedido por ID โจ  โ  โ
โ  โ                          โ    โ   - Actualizar estado        โ  โ
โ  โ                          โ    โ                              โ  โ
โ  โ                          โ    โ โ POST /mp/callback         โ  โ
โ  โ                          โ    โ   - Webhook de MP            โ  โ
โ  โ                          โ    โ   - Procesar pago            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  ranking.js (PREVIOUSLY MODIFIED)                           โ  โ
โ  โ                                                              โ  โ
โ  โ  โ POST /recalcular (AHORA PรBLICO)                        โ  โ
โ  โ     - Deduplicar rankings                                   โ  โ
โ  โ     - Reasignar posiciones                                  โ  โ
โ  โ                                                              โ  โ
โ  โ  โ POST /evaluar-donacion                                  โ  โ
โ  โ     - Actualizar estado de PedidoDonacion                   โ  โ
โ  โ     - Calcular puntos (cantidad ร tipo.puntos)              โ  โ
โ  โ     - Incrementar puntosActuales                            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                          โ Prisma ORM                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

                              โ Queries SQL

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    DATABASE (PostgreSQL)                            โ
โ                                                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ Usuario                  โ    โ PedidoDonacion               โ  โ
โ  โโ id_usuario             โ    โโ id_pedido (PK)             โ  โ
โ  โโ nombre_usuario         โ    โโ id_usuario (FK)            โ  โ
โ  โโ id_tipo_usuario        โ    โโ id_tipo_donacion (FK)      โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ cantidad                   โ  โ
โ                                  โโ estado_evaluacion          โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ puntos_otorgados          โ  โ
โ  โ DetalleUsuario           โ    โโ fecha_donacion            โ  โ
โ  โโ id_usuario (FK)        โ    โโ fecha_evaluacion          โ  โ
โ  โโ puntosActuales         โ                                  โ  โ
โ  โโ ultima_fecha_actualiza โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                  โ TipoDonacion                 โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโ id_tipo_donacion (PK)      โ  โ
โ  โ TipoDonacion             โ    โโ tipo_donacion (name)       โ  โ
โ  โโ id_tipo_donacion (PK)  โ    โโ puntos (value per item)    โ  โ
โ  โโ tipo_donacion          โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โโ puntos                 โ                                      โ
โ     (5=ropa, 10=dinero)    โ                                      โ
โ                            โ                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo Completo de Donaciรณn No-Monetaria

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. USUARIO LLENA FORMULARIO EN FRONTEND                         โ
โ                                                                 โ
โ    ongId: 5                                                     โ
โ    donationType: "ropa"                                         โ
โ    itemDescription: "10 camisetas"                              โ
โ    cantidad: 10                                                 โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. FRONTEND VALIDA (Client-side)                               โ
โ                                                                 โ
โ    โ Usuario autenticado                                       โ
โ    โ donationType en ['dinero','ropa','juguetes',...]         โ
โ    โ itemDescription no vacรญo                                  โ
โ    โ cantidad > 0                                              โ
โ                                                                 โ
โ    Si falla โ Mostrar error en UI                              โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. FRONTEND ENVรA: POST /api/donations                          โ
โ                                                                 โ
โ    Headers: Authorization: Bearer $TOKEN                        โ
โ    Body: {ongId, donationType, itemDescription, cantidad}      โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. BACKEND VALIDA (Server-side)                                โ
โ                                                                 โ
โ    โ JWT vรกlido                                                โ
โ    โ ONG existe y tipo_usuario = 2                            โ
โ    โ Tipo donaciรณn en BD (1-6)                                โ
โ    โ itemDescription y cantidad vรกlidos                        โ
โ                                                                 โ
โ    Si falla โ Return error code (400/401/404)                  โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5. BACKEND CREA REGISTRO EN BD                                  โ
โ                                                                 โ
โ    INSERT INTO "PedidoDonacion" (                               โ
โ      id_publicacion_etiqueta,                                   โ
โ      id_usuario,              -- del JWT                        โ
โ      id_tipo_donacion,        -- 2 (ropa)                       โ
โ      cantidad,                -- 10                             โ
โ      estado_evaluacion,       -- 'pendiente'                    โ
โ      fecha_donacion           -- NOW()                          โ
โ    ) RETURNING *                                                โ
โ                                                                 โ
โ    Resultado: id_pedido = 42                                    โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 6. BACKEND RESPONDE AL FRONTEND (201 Created)                   โ
โ                                                                 โ
โ    {                                                            โ
โ      "success": true,                                           โ
โ      "message": "Donaciรณn registrada exitosamente",             โ
โ      "pedidoDonacion": {                                        โ
โ        "id_pedido": 42,                                         โ
โ        "id_usuario": 2,                                         โ
โ        "cantidad": 10,                                          โ
โ        "estado_evaluacion": "pendiente"                         โ
โ      }                                                          โ
โ    }                                                            โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 7. FRONTEND MUESTRA รXITO                                       โ
โ                                                                 โ
โ    โ Donaciรณn registrada!                                      โ
โ       Tu donaciรณn estรก pendiente de evaluaciรณn por la ONG       โ
โ                                                                 โ
โ    Limpiar formulario                                           โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ                                             โ
             โผ                                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 8A. ONG EVALรA DONACIรN      โ    โ 8B. EN PARALELO: USUARIO    โ
โ                              โ    โ     VE DONACIรN EN MI LISTA โ
โ POST /api/ranking/          โ    โ                             โ
โ      evaluar-donacion        โ    โ GET /api/donations/         โ
โ                              โ    โ     my-donations            โ
โ {id_pedido: 42, aceptada: tr}โ    โ                             โ
โ                              โ    โ Muestra: id_pedido=42       โ
โ                              โ    โ          estado=pendiente   โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโ
             โ                                   โ
             โผ                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ 9. CALCULAR PUNTOS           โ                โ
โ                              โ                โ
โ cantidad ร tipo.puntos       โ                โ
โ 10 ร 5 (ropa=5) = 50 puntos  โ                โ
โ                              โ                โ
โ UPDATE "PedidoDonacion"      โ                โ
โ   SET estado_evaluacion='    โ                โ
โ       aprobada',             โ                โ
โ       puntos_otorgados=50    โ                โ
โ WHERE id_pedido=42           โ                โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ                โ
             โ                                   โ
             โผ                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ 10. INCREMENTAR PUNTOS USUARIOโ                โ
โ                              โ                โ
โ UPDATE "DetalleUsuario"      โ                โ
โ   SET puntosActuales += 50   โ                โ
โ WHERE id_usuario = 2 (donor) โ                โ
โ                              โ                โ
โ UPDATE "DetalleUsuario"      โ                โ
โ   SET puntosActuales += 50   โ                โ
โ WHERE id_usuario = 5 (ONG)   โ                โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ                โ
             โ                                   โ
             โผ                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                โ
โ 11. RECALCULAR RANKING       โ                โ
โ                              โ                โ
โ POST /api/ranking/recalcular โ                โ
โ                              โ                โ
โ (Usuario automรกticamente     โ                โ
โ  aparece en ranking con 50ptsโ                โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโ                โ
             โ                                   โ
             โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 12. VERIFICACIรN FINAL EN FRONTEND                              โ
โ                                                                 โ
โ GET /api/ranking                                                โ
โ                                                                 โ
โ Muestra:                                                        โ
โ Puesto 1: Usuario (50 puntos)                                   โ
โ Puesto 2: OtraPersona (45 puntos)                              โ
โ ...                                                             โ
โ                                                                 โ
โ โ Usuario aparece en ranking con puntos de donaciรณn evaluada   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Flujo Mercado Pago (Mejorado)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 1. USUARIO ELIGE DONAR DINERO EN FRONTEND                       โ
โ                                                                 โ
โ    ongId: 5                                                     โ
โ    description: "Donaciรณn para proyecto X"                      โ
โ    amount: 100 (ARS)                                            โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 2. FRONTEND ENVรA: POST /api/payments/mp/create                 โ
โ                                                                 โ
โ    Headers: Authorization: Bearer $TOKEN                        โ
โ    Body: {ongId, description, amount}                           โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 3. BACKEND VALIDA CREDENCIALES (NUEVO PASO 1)                  โ
โ                                                                 โ
โ    โ ONG existe y tipo_usuario = 2                            โ
โ    โ ONG tiene MP habilitado (mp_enabled = true)              โ
โ    โ Token MP desencriptado correctamente                      โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 4. โจ BACKEND CREA PedidoDonacion ANTES DE MP (NUEVO!)          โ
โ                                                                 โ
โ    const dineroTipo = TipoDonacion("Dinero")                   โ
โ    const etiqueta = "Donaciones Monetarias"                    โ
โ    const publicacion = "Donaciรณn Monetaria Directa"            โ
โ                                                                 โ
โ    INSERT INTO "PedidoDonacion" (                               โ
โ      id_publicacion_etiqueta,                                   โ
โ      id_usuario,              -- del JWT (donor)               โ
โ      id_tipo_donacion,        -- 1 (dinero)                    โ
โ      cantidad,                -- 100 (monto)                   โ
โ      estado_evaluacion,       -- 'pendiente'                   โ
โ      fecha_donacion           -- NOW()                         โ
โ    ) RETURNING *                                                โ
โ                                                                 โ
โ    Resultado: id_pedido = 43                                    โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 5. BACKEND CREA PREFERENCIA MERCADOPAGO (CON METADATA)          โ
โ                                                                 โ
โ    const preference = {                                         โ
โ      items: [{                                                  โ
โ        title: description,                                      โ
โ        unit_price: 100,                                         โ
โ        quantity: 1,                                             โ
โ        currency_id: 'ARS'                                       โ
โ      }],                                                        โ
โ      metadata: {          โ โจ NUEVA REFERENCIA                โ
โ        ongId: "5",                                              โ
โ        donorId: "2",                                            โ
โ        pedidoId: "43"     โ โจ ID DEL PEDIDO CREADO ARRIBA    โ
โ      },                                                         โ
โ      back_urls: {                                               โ
โ        success: "/api/payments/mp/process-payment",             โ
โ        failure: "/api/payments/mp/process-payment",             โ
โ        pending: "/api/payments/mp/process-payment"              โ
โ      }                                                          โ
โ    }                                                            โ
โ                                                                 โ
โ    Resultado: preferenceId = "987654321"                        โ
โ              init_point = "https://www.mercadopago.com/..."     โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 6. BACKEND RESPONDE CON PREFERENCIA                             โ
โ                                                                 โ
โ    { id: "987654321", init_point: "https://..." }               โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 7. FRONTEND REDIRIGE A MERCADOPAGO CHECKOUT                     โ
โ                                                                 โ
โ    window.location = "https://www.mercadopago.com/..."          โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 8. USUARIO COMPLETA PAGO EN MERCADOPAGO                         โ
โ                                                                 โ
โ    โ Ingresa tarjeta                                           โ
โ    โ Completa datos                                            โ
โ    โ Paga $100                                                 โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 9. MERCADOPAGO PROCESA PAGO Y CREA TRANSACCIรN                  โ
โ                                                                 โ
โ    paymentId: "1234567890"                                      โ
โ    status: "approved" (o "pending", "rejected")                โ
โ    metadata: {ongId: "5", donorId: "2", pedidoId: "43"}        โ
โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ
             โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโ
             โ                      โ                        โ
             โผ                      โผ                        โผ
      (Callback GET)        (Webhook POST)        (Caso: Pรกgina refrescada)
         โ                      โ                        โ
         โผ                      โผ                        โผ
โโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโ         โโโโโโโโโโโโโโโโ
โ MP redirige  โ         โ MP envรญa     โ         โ Usuario vuelve
โ a:           โ         โ webhook a:   โ         โ a frontend
โ /api/paymentsโ         โ /api/paymentsโ         โ con ?payment_
โ /mp/process- โ         โ /mp/callback โ         โ id=1234567890
โ payment?pay- โ         โ              โ         โ
โ ment_id=1234 โ         โ              โ         โ
โ 567890       โ         โ              โ         โ
โโโโโโโโโโฌโโโโโโ         โโโโโโโโโโฌโโโโโโ         โโโโโโโโโโฌโโโโโโโ
         โ                        โ                        โ
         โผ                        โผ                        โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 10. โจ BACKEND PROCESA PAGO CON ID DIRECTO (MEJORADO)            โ
โ                                                                  โ
โ     GET paymentData from MP using paymentId                      โ
โ     paymentData.metadata = {ongId, donorId, pedidoId}            โ
โ                                                                  โ
โ     โจ BUSCA PEDIDO POR ID (O(1), muy rรกpido):                  โ
โ     findUnique({                                                โ
โ       where: { id_pedido: parseInt(paymentData.metadata.         โ
โ         pedidoId) }                                             โ
โ     })                                                           โ
โ                                                                  โ
โ     Antes: Buscaba por timestamp (lento, mรบltiples queries)      โ
โ     Ahora: Busca por ID directo (1 query rรกpida)                โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 11. VALIDA OWNERSHIP                                             โ
โ                                                                  โ
โ     if (pedidoDonacion.id_usuario !== donorId ||                โ
โ         pedidoDonacion.publicacion.id_usuario !== ongId) {      โ
โ       return error "Validaciรณn de propietarios fallida"         โ
โ     }                                                            โ
โ                                                                  โ
โ     โ Previene manipulaciones                                  โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 12. SI PAGO APROBADO: ACTUALIZAR ESTADO                          โ
โ                                                                  โ
โ     if (paymentData.status === 'approved') {                    โ
โ       UPDATE "PedidoDonacion" SET                                โ
โ         estado_evaluacion = 'aprobada',                         โ
โ         fecha_evaluacion = NOW(),                               โ
โ         puntos_otorgados = 100 * 10 = 1000  โ Auto-calc        โ
โ       WHERE id_pedido = 43                                      โ
โ     }                                                            โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 13. INCREMENTAR PUNTOS EN DetalleUsuario                         โ
โ                                                                  โ
โ     UPDATE "DetalleUsuario"                                      โ
โ       SET puntosActuales += 1000                                โ
โ     WHERE id_usuario = 2 (donor)                                โ
โ                                                                  โ
โ     UPDATE "DetalleUsuario"                                      โ
โ       SET puntosActuales += 1000                                โ
โ     WHERE id_usuario = 5 (ONG)                                  โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 14. RESPONDER A FRONTEND                                         โ
โ                                                                  โ
โ     Si callback GET: Redirigir a /donaciones/exito              โ
โ     Si webhook POST: Responder 200 OK                           โ
โ     Si pago pending: Redirigir a /donaciones/pendiente          โ
โ     Si pago rejected: Redirigir a /donaciones/error             โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ 15. FRONTEND MUESTRA RESULTADO                                   โ
โ                                                                  โ
โ     โ ยกDonaciรณn completada!                                     โ
โ     Tu donaciรณn de $100 ha sido procesada y aprobada.           โ
โ     Has ganado 1000 puntos.                                     โ
โ                                                                  โ
โ     (Usuario aparece en ranking con 1000 nuevos puntos)         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Comparativa: Antes vs Despuรฉs

### ANTES
| Aspecto | Situaciรณn |
|---------|-----------|
| No-monetarias | Guardadas en BD: โ Solo UI |
| Monetarias | Pedido creado despuรฉs de MP |
| Bรบsqueda de pedido en callback | Bรบsqueda por timestamp (lenta) |
| Puntos | No se calculaban |
| Ranking | Duplicados + saltos |

### DESPUรS
| Aspecto | Situaciรณn |
|---------|-----------|
| No-monetarias | Guardadas en BD: โ POST /api/donations |
| Monetarias | Pedido creado ANTES de MP |
| Bรบsqueda de pedido en callback | Bรบsqueda por ID desde metadata (rรกpida) |
| Puntos | Se calculan automรกticamente |
| Ranking | Deduplicado + secuencial |

---

## ๐ Cambios Clave

### 1. **Endpoint Nuevo: POST /api/donations**
```
Antes: Funciรณn existe pero es vacรญa
Ahora: Crea PedidoDonacion en BD
```

### 2. **PedidoDonacion ANTES de MP**
```
Antes: INSERT despuรฉs de preferencia
Ahora: INSERT ANTES de preferencia
Beneficio: Metadata puede guardar pedidoId
```

### 3. **Bรบsqueda por ID en Metadata**
```
Antes: findFirst() con filtros de timestamp
Ahora: findUnique() con ID directo
Velocidad: ~100x mรกs rรกpido
```

### 4. **Validaciรณn de Ownership**
```
Antes: Sin validaciรณn
Ahora: Verifica que pedido pertenece a usuarios correctos
Seguridad: Previene manipulaciones
```

### 5. **Deduplicaciรณn de Ranking**
```
Antes: Sin dedup, saltos en posiciones
Ahora: dedupeByUserId() + assignSequentialPositions()
Resultado: Posiciones 1, 2, 3... sin duplicados
```

---

## ๐ฏ Impacto en Usuario

### Donante Regular
1. Dona dinero โ Se guarda en BD
2. ONG evalรบa โ Recibe puntos automรกticamente
3. Ve ranking โ Aparece con sus puntos

### ONG
1. Recibe donaciรณn โ Ve en panel (pendiente)
2. Evalรบa donaciรณn โ Aprueba/rechaza
3. Sistema calcula โ Puntos para donante y para ONG

### Admin/Developer
1. Ver logs โ โ PedidoDonacion creado, โ Pago procesado
2. Debugging โ ID directo en metadata, validaciรณn clara
3. Testing โ Endpoints pรบblicos, sin headers complejos

---

**รltima actualizaciรณn:** 2024
**Versiรณn:** 1.0
**Status:** โ LISTO PARA DEPLOYMENT
